<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GIVEAWAY Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary-bg: #FFF0F5; /* Lavender Blush */
      --card-bg: rgba(255, 255, 255, 0.9);
      --text-color: #333;
      --accent-color: #FF1493; /* Deep Pink */
      --accent-hover-color: #FF69B4; /* Hot Pink */
      --accent-color-rgb: 255, 20, 147;
      --card-border-color: rgba(255, 20, 147, 0.4);
      --popup-bg: #ffffff;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--primary-bg);
      color: var(--text-color);
      position: relative;
      min-height: 100vh;
      overflow-y: auto;
      padding: 1rem;
    }

    .card {
      transition: all 0.3s ease;
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--card-border-color);
      backdrop-filter: blur(5px);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }
    
    .card:hover {
      box-shadow: 0 12px 40px rgba(var(--accent-color-rgb), 0.2);
    }
    
    svg.header-svg {
      width: 80%;
      height: auto;
      overflow: visible;
      margin: 0 auto;
      display: block;
    }

    svg.header-svg text {
      text-anchor: middle;
      dominant-baseline: middle;
      text-transform: uppercase;
      animation: stroke 5s infinite alternate;
      stroke-width: 2;
      stroke: var(--accent-color);
      font-size: 70px; /* Adjusted for better fit */
      fill: rgba(255, 255, 255, 0);
      font-family: 'Orbitron', sans-serif;
    }

    @keyframes stroke {
      0% { fill: rgba(255, 255, 255, 0); stroke: var(--accent-color); stroke-dashoffset: 25%; stroke-dasharray: 0 50%; stroke-width: 2; }
      70% { fill: rgba(255, 255, 255, 0); stroke: var(--accent-hover-color); }
      80% { fill: rgba(255, 255, 255, 0); stroke: var(--accent-color); stroke-width: 3; }
      100% { fill: var(--accent-color); stroke: rgba(var(--accent-color-rgb), 0); stroke-dashoffset: -25%; stroke-dasharray: 50% 0; stroke-width: 0; }
    }

    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      display: flex;
      flex-direction: column;
      background: var(--popup-bg);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 8px 16px rgba(0,0,0, 0.2);
      border: 2px solid var(--accent-color);
      text-align: center;
      width: 90%;
      max-width: 400px;
      color: var(--text-color);
    }

    .popup.show {
        display: flex;
    }

    .popup-button {
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      border-radius: 0.5rem;
      font-weight: bold;
      transition: all 0.3s ease;
      background: var(--accent-color);
      color: white;
      border: none;
      cursor: pointer;
    }

    .popup-button:hover {
      background: var(--accent-hover-color);
      transform: scale(1.05);
    }

    .cancel-btn {
        background: #9ca3af;
    }
    .cancel-btn:hover {
        background: #6b7280;
    }

    .input-field {
      background: #FFFFFF;
      border: 2px solid var(--accent-color);
      color: var(--text-color);
      padding: 0.75rem;
      border-radius: 0.5rem;
      width: 100%;
      outline: none;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      box-shadow: 0 0 12px rgba(var(--accent-color-rgb), 0.3);
    }
    
    .key-list-container {
        overflow-x: auto;
    }

    .key-item, .key-header {
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr));
      align-items: center;
      width: 100%;
      min-width: 600px;
    }

    .key-item {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease-in-out;
    }
    .key-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .key-header {
        padding: 1rem;
        background: transparent;
        border-radius: 8px;
        font-weight: bold;
        color: var(--accent-color);
        text-align: center;
        font-size: 0.9rem;
    }
    
    .delete-btn, .copy-btn {
      color: var(--accent-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .delete-btn:hover, .copy-btn:hover {
      color: var(--accent-hover-color);
      transform: scale(1.2);
    }

    .copy-feedback {
      display: none;
      color: #22c55e;
      font-size: 0.8rem;
    }
    .copy-feedback.show {
      display: inline-block;
    }
    
    .expired { color: #ef4444; }
    .valid { color: #22c55e; }

  </style>
</head>
<body>
  <!-- Server Toggle & Message Buttons -->
  <div class="fixed top-4 left-4 right-4 flex justify-between z-20">
    <button id="serverToggleBtn" class="popup-button flex items-center shadow-lg">
      <i class="fas fa-power-off mr-2"></i><span id="serverStatusText">Loading...</span>
    </button>
    <button id="customMessageBtn" class="popup-button flex items-center shadow-lg">
      <i class="fas fa-comment-dots mr-2"></i>Message All
    </button>
  </div>

  <!-- Header -->
  <header class="text-center mt-16 mb-2">
    <svg viewBox="0 0 800 200" class="header-svg">
      <text x="50%" y="50%">GIVEAWAY ADMIN</text>
    </svg>
  </header>

  <!-- Main Content -->
  <div class="max-w-full mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left Column: Controls -->
    <div>
      <!-- Create Key Card -->
      <div class="card p-6">
        <h2 class="text-2xl font-bold text-center mb-6" style="color: var(--accent-color);">
          Create Access Key
        </h2>
        <div class="space-y-4">
          <div>
            <label for="expiryHours" class="block text-sm mb-1 font-semibold" style="color: var(--accent-color);">Expiry (Hours)</label>
            <input id="expiryHours" type="number" class="input-field" placeholder="e.g., 24 for 1 day">
          </div>
          <div>
            <label for="deviceIdInput" class="block text-sm mb-1 font-semibold" style="color: var(--accent-color);">Device ID (Optional)</label>
            <input id="deviceIdInput" type="text" class="input-field" placeholder="Enter Device ID to bind key">
          </div>
          <div class="text-center">
            <button onclick="createKey()" class="popup-button w-full flex items-center justify-center">
              <i class="fas fa-key mr-2"></i>Create Key
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Right Column: Key List -->
    <div class="card p-6">
      <h2 class="text-2xl font-bold text-center mb-6" style="color: var(--accent-color);">
        Access Key List
      </h2>
      <div class="key-list-container">
          <div class="key-header">
            <span>Key</span>
            <span>Expiry Date</span>
            <span>Device ID</span>
            <span>Copy</span>
            <span>Action</span>
          </div>
          <div id="keyList" class="mt-2 space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Popups -->
  <div id="messagePopup" class="popup">
    <div class="popup-content">
      <p id="messageText" class="text-lg font-semibold mb-4"></p>
      <button id="closeMessageBtn" class="popup-button">Close</button>
    </div>
  </div>

  <div id="deletePopup" class="popup">
    <div class="popup-content">
      <p id="deleteMessage" class="text-lg font-semibold mb-4"></p>
      <div class="flex justify-center gap-4">
        <button id="confirmDeleteBtn" class="popup-button">Confirm</button>
        <button id="cancelDeleteBtn" class="popup-button cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <div id="customMessagePopup" class="popup">
    <div class="popup-content">
      <p class="text-lg font-semibold mb-4">Send Custom Message</p>
      <div class="space-y-4">
        <div>
          <label for="customMessageInput" class="block text-sm mb-1 font-semibold" style="color: var(--accent-color);">Message</label>
          <input id="customMessageInput" type="text" class="input-field" placeholder="Enter your message">
        </div>
        <div class="flex justify-center gap-4">
          <button id="sendMessageBtn" class="popup-button">Send</button>
          <button id="cancelMessageBtn" class="popup-button cancel-btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAbPTODlx_msQ-g620HuZb08gOBfHr79b0",
      authDomain: "giveawayweb-d3f1e.firebaseapp.com",
      databaseURL: "https://giveawayweb-d3f1e-default-rtdb.firebaseio.com",
      projectId: "giveawayweb-d3f1e",
      storageBucket: "giveawayweb-d3f1e.appspot.com",
      messagingSenderId: "376785413992",
      appId: "1:376785413992:web:e1dd342afee0c0ef0f58dd",
      measurementId: "G-L4V9SCWMD5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Key Management ---
    function generateAccessKey() {
      const numbers = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      const letters = Array.from({length: 3}, () => String.fromCharCode(65 + Math.floor(Math.random() * 26))).join('');
      return `SEROX-${numbers}${letters}`;
    }
    
    function createKey() {
      const hours = parseInt(document.getElementById("expiryHours").value.trim());
      const deviceId = document.getElementById("deviceIdInput").value.trim();

      if (isNaN(hours) || hours <= 0) {
        showMessagePopup("Please enter a valid number of expiry hours.");
        return;
      }

      const key = generateAccessKey();
      const now = Date.now();
      const expiry = now + hours * 60 * 60 * 1000;

      db.ref("accessKeys/" + key).set({
        createdAt: now,
        expiry: expiry,
        deviceId: deviceId || null // Save deviceId or null if empty
      }).then(() => {
        showMessagePopup(`Key "${key}" created successfully.`);
        document.getElementById("expiryHours").value = "";
        document.getElementById("deviceIdInput").value = "";
      }).catch(err => {
        showMessagePopup("Error creating key: " + err.message);
      });
    }

    function loadKeys() {
        db.ref("accessKeys").on("value", snapshot => {
            const list = document.getElementById("keyList");
            list.innerHTML = "";
            const data = snapshot.val();
            if (!data) {
                list.innerHTML = "<p class='text-center text-gray-500 col-span-5'>No keys found in the database.</p>";
                return;
            }

            const sortedKeys = Object.entries(data).sort((a, b) => b[1].createdAt - a[1].createdAt);

            sortedKeys.forEach(([key, info], index) => {
                const expired = Date.now() > info.expiry;
                const statusClass = expired ? "expired" : "valid";
                const expiryDate = new Date(info.expiry).toLocaleString();
                const feedbackId = `copyFeedback-${index}`;

                const item = document.createElement("div");
                item.className = "key-item";
                item.innerHTML = `
                    <div class="text-center font-semibold break-all px-2">${key}</div>
                    <div class="text-center ${statusClass} px-2">${expiryDate}</div>
                    <div class="text-center font-mono text-sm break-all px-2">${info.deviceId || "<i>Not Bound</i>"}</div>
                    <div class="text-center relative">
                        <i class="fas fa-copy copy-btn text-xl" onclick="copyKey('${key}', '${feedbackId}')"></i>
                        <span id="${feedbackId}" class="copy-feedback">Copied!</span>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-trash-alt delete-btn text-xl" onclick="showDeletePopup('${key}')"></i>
                    </div>
                `;
                list.appendChild(item);
            });
        });
    }

    function deleteKey(key) {
      db.ref("accessKeys/" + key).remove().then(() => {
        hideDeletePopup();
        showMessagePopup(`Key "${key}" has been deleted.`);
      }).catch(err => {
        showMessagePopup("Error deleting key: " + err.message);
      });
    }

    function copyKey(key, feedbackId) {
      navigator.clipboard.writeText(key)
        .then(() => {
          const feedback = document.getElementById(feedbackId);
          feedback.classList.add('show');
          setTimeout(() => feedback.classList.remove('show'), 2000);
        })
        .catch(err => console.error('Failed to copy key:', err));
    }
    
    // --- Server & Message Controls ---
    function toggleServerStatus() {
      db.ref("serverStatus").get().then(snapshot => {
        const currentStatus = snapshot.val() || { status: "on" };
        const newStatus = currentStatus.status === "on" ? "off" : "on";
        db.ref("serverStatus").set({ status: newStatus, lastUpdated: Date.now() })
          .then(() => showMessagePopup(`Server turned ${newStatus.toUpperCase()}.`));
      });
    }

    function updateServerButton(status) {
      const serverStatusText = document.getElementById('serverStatusText');
      const serverToggleBtn = document.getElementById('serverToggleBtn');
      serverStatusText.textContent = `Server: ${status.toUpperCase()}`;
      if (status === "off") {
        serverToggleBtn.classList.add('cancel-btn');
        serverToggleBtn.classList.remove('popup-button');
      } else {
        serverToggleBtn.classList.add('popup-button');
        serverToggleBtn.classList.remove('cancel-btn');
      }
    }

    function loadServerStatus() {
      db.ref("serverStatus").on("value", snapshot => {
        const serverStatus = snapshot.val() || { status: "on" };
        updateServerButton(serverStatus.status);
      });
    }

    function sendCustomMessage() {
      const message = document.getElementById('customMessageInput').value.trim();
      if (!message) {
        showMessagePopup("Please enter a message to send.");
        return;
      }
      db.ref("customMessage").set({ message: message, timestamp: Date.now() })
        .then(() => {
          hideCustomMessagePopup();
          showMessagePopup("Custom message sent successfully.");
        });
    }

    // --- Popup Handling ---
    function showMessagePopup(message) {
        document.getElementById('messageText').textContent = message;
        document.getElementById('messagePopup').classList.add('show');
    }
    function hideMessagePopup() {
        document.getElementById('messagePopup').classList.remove('show');
    }
    function showDeletePopup(key) {
        document.getElementById('deleteMessage').textContent = `Are you sure you want to delete the key "${key}"?`;
        document.getElementById('deletePopup').classList.add('show');
        document.getElementById('confirmDeleteBtn').dataset.key = key;
    }
    function hideDeletePopup() {
        document.getElementById('deletePopup').classList.remove('show');
    }
    function showCustomMessagePopup() {
        document.getElementById('customMessagePopup').classList.add('show');
    }
    function hideCustomMessagePopup() {
        document.getElementById('customMessagePopup').classList.remove('show');
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
      loadKeys();
      loadServerStatus();

      // Button Listeners
      document.getElementById('serverToggleBtn').addEventListener('click', toggleServerStatus);
      document.getElementById('customMessageBtn').addEventListener('click', showCustomMessagePopup);
      document.getElementById('sendMessageBtn').addEventListener('click', sendCustomMessage);
      document.getElementById('cancelMessageBtn').addEventListener('click', hideCustomMessagePopup);
      document.getElementById('closeMessageBtn').addEventListener('click', hideMessagePopup);
      document.getElementById('confirmDeleteBtn').addEventListener('click', (e) => deleteKey(e.target.dataset.key));
      document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeletePopup);
    });
  </script>
</body>
</html>
